<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Confissão de Dívida (v6-com Negativo)</title>
    
    <script>
        // SCRIPT DE GUARDA DE AUTENTICAÇÃO
        if (localStorage.getItem('isAuthenticated') !== 'true') {
            alert("Acesso negado. Por favor, faça o login.");
            window.location.replace('index.html'); 
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@latest/dist/tesseract.min.js'></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            align-items: flex-start;
            gap: 30px;
            padding: 20px;
            font-size: 14px; 
            flex-wrap: wrap; 
            justify-content: center;
        }

        #form-container {
            flex: 0 0 450px;
            background: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 20px;
            max-height: 95vh;
            overflow-y: auto;
        }

        #form-container h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.5rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #btn-logout {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border: 1px solid #dc3545;
            color: #dc3545;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        #btn-logout:hover {
            background: #dc3545;
            color: #fff;
        }

        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .form-section:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
        }
        .form-section h2 {
            font-size: 1.1rem;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-section h2 .btn-limpar {
            font-size: 0.8rem;
            font-weight: normal;
            padding: 2px 8px;
            border: 1px solid #dc3545;
            color: #dc3545;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-section h2 .btn-limpar:hover {
            background: #dc3545;
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group input[type="text"]:disabled {
            background-color: #e9ecef;
        }

        #gerar-pdf {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #gerar-pdf:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #gerar-pdf:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* --- ESTILOS DO PREVIEW (ATUALIZADOS) --- */
        #preview-container {
            flex: 1; 
            display: flex;
            justify-content: center; 
            min-width: 1mm; 
        }

        #documento-completo {
            width: 158mm; 
            padding: 0;
            margin: 0;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            font-size: 10pt;
            line-height: 1.5;
        }
        
        #documento-completo h3 {
            text-align: center;
            font-weight: bold;
            font-size: 12pt;
            margin-bottom: 25px;
            page-break-inside: avoid !important;
        }

        #documento-completo p {
            text-align: justify; 
            margin-bottom: 15px; 
            text-indent: 50px;
            word-wrap: break-word; 
            page-break-inside: avoid !important;
        }
        
        #documento-completo .no-indent {
            text-indent: 0;
        }

        #documento-completo .clausula {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 10px;
            text-indent: 0;
            page-break-inside: avoid !important;
            page-break-after: avoid !important; 
        }

        #documento-completo .paragrafo {
            margin-left: 25px;
            text-indent: 0;
            text-align: justify;
            margin-bottom: 15px; 
        }
        #documento-completo .paragrafo-no-indent {
            text-indent: 0;
            text-align: justify;
            margin-bottom: 15px; 
        }

        #documento-completo .assinatura {
            text-align: center;
            margin-top: 40px; 
            text-indent: 0;
            page-break-inside: avoid !important; 
        }

        #documento-completo .data-local {
            text-align: center;
            margin-top: 40px;
            text-indent: 0;
            page-break-inside: avoid !important;
        }

        .variavel {
            font-weight: bold;
            color: #0d47a1;
            transition: color 0.3s ease;
        }

        .generating-pdf .variavel {
            color: #000;
            font-weight: normal;
        }
        
        .preview-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            margin-bottom: 15px;
            margin-top: 15px;
            page-break-inside: avoid !important; 
        }
        .preview-table th,
        .preview-table td {
            border: 1px solid #000;
            padding: 4px 6px;
            text-align: center;
            white-space: normal;
            overflow-wrap: break-word;
        }
        .preview-table th {
            font-weight: bold;
            background-color: #f2f2f2;
        }


        /* === CSS DO LEITOR DE PDF E COMPONENTES === */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 80px; gap: 10px; }

        .grid-contrato-dinamico { 
            display: grid;
            grid-template-columns: 1fr 1fr 30px; /* Banco, Parcela, Botão */
            gap: 10px;
            align-items: flex-end;
        }
        .grid-contrato-dinamico .form-group { margin-bottom: 0; }
        .grid-contrato-dinamico label, .grid-2 label, .grid-3 label { font-size: 0.8rem; }

        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1090; }
        .toast {
            width: 350px; max-width: 90%; background-color: #333; color: white;
            padding: 15px; border-radius: 5px; margin-bottom: 10px;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.bg-success { background-color: #198754; }
        .toast.bg-danger { background-color: #dc3545; }
        .toast.bg-warning { background-color: #ffc107; color: #000; }

        .upload-area {
            border: 2px dashed #007bff; padding: 20px; text-align: center;
            cursor: pointer; background-color: #f8f9fa;
            transition: background-color 0.2s, border-color 0.2s;
            border-radius: 8px; margin-bottom: 15px;
        }
        .upload-area.hover { background-color: #e9ecef; border-color: #0056b3; }
        #pdf-upload { display: none; }
        .upload-area span { font-weight: bold; color: #007bff; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #contract-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1050;
            display: none; justify-content: center; align-items: center;
        }
        #contract-modal {
            background: #fff; border-radius: 8px; width: 90%; max-width: 600px;
            display: flex; flex-direction: column; max-height: 80vh;
        }
        #contract-modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; }
        #contract-modal-body { padding: 20px; overflow-y: auto; }
        #modal-sum-container {
            padding: 12px 15px; background: #f0f2f5; border: 1px solid #ddd;
            border-radius: 4px; margin-top: 15px; font-size: 1.05rem;
            text-align: center; display: none; font-weight: 500;
        }
        #modal-sum-container strong { font-size: 1.1rem; color: #198754; }
        #contract-list .form-check {
            display: block; padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        #contract-list .form-check:hover { background-color: #f8f9fa; }
        #contract-list .form-check.select-all:hover { background-color: transparent; }
        #contract-modal-footer {
            padding: 15px 20px; border-top: 1px solid #eee;
            display: flex; justify-content: flex-end; gap: 10px;
        }
        .modal-btn {
            padding: 8px 15px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        
        #btn-add-contrato {
            width: 100%; margin-top: 15px; padding: 10px;
            background: #e6f7ff; border: 1px dashed #007bff;
            color: #007bff; font-weight: bold; cursor: pointer;
        }
        .btn-remover-contrato {
            background: #dc3545; color: white; border: none;
            width: 30px; height: 30px; border-radius: 4px;
            cursor: pointer; font-weight: bold; display: flex;
            align-items: center; justify-content: center; padding-bottom: 3px;
        }
        
        /* Classe auxiliar do html2pdf.js */
        @media print,
        (min-width: 0px) {
            .jsPDF-native-generating {
                display: block;
                background-color: #fff;
                padding: 0;
                margin: 0;
            }
            .jsPDF-native-generating #form-container,
            .jsPDF-native-generating .toast-container,
            .jsPDF-native-generating #loading-overlay,
            .jsPDF-native-generating #contract-modal-overlay {
                display: none;
            }
            .jsPDF-native-generating #preview-container {
                flex: none;
                justify-content: flex-start;
                margin: 0;
                padding: 0;
                min-width: 0;
            }
            .jsPDF-native-generating #documento-completo {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>
<body>

    <div class="toast-container" id="toast-container"></div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <span id="loading-text">Analisando PDF...</span>
    </div>
    <div id="contract-modal-overlay">
        <div id="contract-modal">
            <div id="contract-modal-header">
                <h3>Selecione os Contratos</h3>
            </div>
            <div id="contract-modal-body">
                <div id="infoClienteModal" class="p-2 mb-3"
                    style="background: #f0f2f5; border-radius: 4px; border: 1px solid #ddd; display: none;">
                    <p class="mb-1"><strong>Cliente:</strong> <span id="modal-nome-cliente"></span></p>
                    <p class="mb-0"><strong>CPF:</strong> <span id="modal-cpf-cliente"></span></p>
                </div>
                <div id="contract-list"></div>
                <div id="modal-sum-container">
                    Soma das parcelas selecionadas: <strong id="modal-sum-value">R$ 0,00</strong>
                </div>
            </div>
            <div id="contract-modal-footer">
                <button id="modal-cancel-btn" class="modal-btn btn-secondary">Cancelar</button>
                <button id="modal-apply-btn" class="modal-btn btn-primary">Aplicar Selecionados</button>
            </div>
        </div>
    </div>


    <div id="form-container">
        <h1>
            Gerar Confissão de Dívida
            <button id="btn-logout" title="Sair do sistema">Sair</button>
        </h1>

        <div class="form-section">
            <h2>Dados do Cliente</h2>
            <div class="form-group">
                <label for="nome">Nome Completo:</label>
                <input type="text" id="nome" placeholder="FULANO DE TAL">
            </div>
            <div class="form-group">
                <label for="rg">RG (com emissor):</label>
                <input type="text" id="rg" placeholder="N°RG SSP-ESTADO">
            </div>
            <div class="form-group">
                <label for="cpf">CPF:</label>
                <input type="text" id="cpf" placeholder="xxx.xxx.xxx-xx">
            </div>
            <div class="form-group">
                <label for="orgao">Órgão Vinculado:</label>
                <input type="text" id="orgao" placeholder="Polícia Militar do Distrito Federal">
            </div>

            <div class="grid-3">
                <div class="form-group" style="grid-column: span 3;"><label for="cep">CEP (Digite e saia do campo para buscar):</label><input type="text" id="cep" placeholder="71.xxx-xxx">
                </div>
            </div>
            <div class="form-group">
                <label for="endereco">Endereço (Logradouro, Bairro, Cidade/UF):</label>
                <input type="text" id="endereco" placeholder="Quadra ... CEP: 71.xxx-xxx – Brasília/DF">
            </div>
        </div>
        
        <div class="form-section">
            <h2>Contratos a Quitar <button class="btn-limpar" id="limpar-contratos-btn">Limpar</button></h2>
            <input type="file" id="pdf-upload" accept=".pdf">
            <label for="pdf-upload" class="upload-area" id="upload-label">
                <span>Clique ou arraste o Extrato/Contracheque PDF</span>
            </label>
            <div id="contratos-dinamicos-container"
                style="display: flex; flex-direction: column; gap: 15px; margin-top:15px;">
            </div>
            <button type="button" id="btn-add-contrato">
                + Adicionar Contrato Manualmente
            </button>
        </div>

        <div class="form-section">
            <h2>Valores da Operação</h2>
            <div class="form-group">
                <label for="margem-utilizada">Houve utilização de margem consignável?</label>
                <select id="margem-utilizada">
                    <option value="Não">Não</option>
                    <option value="Sim">Sim</option>
                </select>
            </div>
            <div class="form-group">
                <label for="valor-margem">Valor da Margem (se sim):</label>
                <input type="text" id="valor-margem" placeholder="R$ 0,00" class="campo-moeda">
            </div>
            <div class="form-group">
                <label for="valor-parcelas-unificadas">Valor final das parcelas unificadas:</label>
                <input type="text" id="valor-parcelas-unificadas" placeholder="R$ 0,00" class="campo-moeda">
            </div>
            
            <div class="form-group">
                <label for="tirou-negativo">Tirou o negativo?</label>
                <select id="tirou-negativo">
                    <option value="Não">Não</option>
                    <option value="Sim">Sim</option>
                </select>
            </div>
            <div id="negativo-container" style="display: none; padding-left: 15px; border-left: 3px solid #007bff; margin-bottom: 15px;">
                <div class="form-group">
                    <label for="valor-negativo">Valor do Negativo:</label>
                    <input type="text" id="valor-negativo" placeholder="R$ 0,00" class="campo-moeda">
                </div>
                <div class="form-group">
                    <label for="parcela-com-abatimento">Nova Parcela (Retirando Negativo):</label>
                    <input type="text" id="parcela-com-abatimento" placeholder="R$ 0,00" class="campo-moeda" disabled>
                </div>
            </div>
            <div class="form-group">
                <label for="prazo">Prazo (em vezes):</label>
                <input type="text" id="prazo" placeholder="96 vezes">
            </div>
            
            <div class="form-group">
                <label for="saldo-devedor-quitado">Saldo Devedor a ser Quitado:</label>
                <input type="text" id="saldo-devedor-quitado" placeholder="R$ 0,00" class="campo-moeda">
            </div>
            <div class="form-group">
                <label for="valor-total-nova-instituicao">Valor Total Aprox. na Nova Instituição:</label>
                <input type="text" id="valor-total-nova-instituicao" placeholder="R$ 0,00" class="campo-moeda">
            </div>
            <div class="form-group">
                <label for="valor-liquido">Valor líquido a ser recebido:</label>
                <input type="text" id="valor-liquido" placeholder="R$ 0,00" class="campo-moeda">
            </div>
            <div class="form-group">
                <label for="valor-repassado">Valor total a ser repassado à empresa:</label>
                <input type="text" id="valor-repassado" placeholder="R$ 0,00" class="campo-moeda">
            </div>
        </div>

        <div class="form-section">
            <h2>Local e Data</h2>
            <div class="form-group">
                <label for="local-data">Local e Data:</label>
                <input type="text" id="local-data" value="">
            </div>
        </div>
        
        <button id="gerar-pdf">Gerar PDF</button>
    </div>

    <div id="preview-container">
        <div id="documento-completo">
            <h3>TERMO DE CIÊNCIA, DE RESPONSABILIDADE E CONFISSÃO DE DÍVIDA</h3>
            <p>
                Eu, <span id="doc-nome" class="variavel">[Nome]</span>, portador da cédula de identidade R.G.
                nº <span id="doc-rg" class="variavel">[RG]</span>, brasileiro, inscrito no CPF nº <span id="doc-cpf" class="variavel">[CPF]</span>, residente e domiciliado na <span id="doc-endereco" class="variavel">[Endereço]</span>, vinculado ao órgão <span id="doc-orgao" class="variavel">[Órgão]</span>.
            </p>
            <p>
                DECLARO, para os devidos fins, que autorizo a empresa POLLO PROMOTORA LTDA, inscrita no CNPJ sob o nº 44.906.703/0001-59, com sede na CSE 06, Lote 30, Sala 204 – Taguatinga Sul – CEP: 72025-065 – Brasília/DF, a realizar a quitação dos contratos consignados em meu contracheque, conforme descrito abaixo: A realizar a quitação do(s) contrato(s) de minha responsabilidade que estão consignados em meu holerite de pagamento conforme descrição abaixo:
            </p>
            <p class="clausula">CLÁUSULA PRIMEIRA – DA OPERAÇÃO</p>

            <table class="preview-table" id="tabela-quitar">
                <thead>
                    <tr>
                        <th>BANCO A QUITAR</th>
                        <th>VALOR PARCELA</th>
                    </tr>
                </thead>
                <tbody id="doc-contratos-tbody">
                    <tr class="placeholder-row">
                        <td colspan="2">Nenhum contrato adicionado</td>
                    </tr>
                </tbody>
            </table>

            <p class="paragrafo-no-indent">
                Houve utilização de margem consignável? ( <span id="doc-margem-utilizada" class="variavel">[Sim/Não]</span> ) Se sim, qual o valor? <span id="doc-valor-margem" class="variavel">[Valor Margem]</span>
            </p>
            <p class="paragrafo">
                Valor final das parcelas unificadas: <span id="doc-valor-parcelas-unificadas" class="variavel">[Valor Parcelas Unificadas]</span>
            </p>
            
            <p class="paragrafo" id="preview-valor-negativo" style="display: none;">
                Valor do Negativo: <span id="doc-valor-negativo" class="variavel">R$ 0,00</span>
            </p>
            <p class="paragrafo" id="preview-parcela-abatimento" style="display: none;">
                Nova Parcela (Retirando Negativo) <span id="doc-parcela-com-abatimento" class="variavel">R$ 0,00</span>
            </p>
            <p class="paragrafo">
                Prazo: <span id="doc-prazo" class="variavel">[Prazo]</span>
            </p>
            <p class="paragrafo">
                Saldo Devedor a ser Quitado: <span id="doc-saldo-devedor-quitado" class="variavel">[Saldo Devedor Quitado]</span>
            </p>
            <p class="paragrafo">
                Valor Total Aprox. Nova Instituição: <span id="doc-valor-total-nova-instituicao" class="variavel">[Valor Total Nova Instituição]</span>
            </p>
            <p class="clausula">CLÁUSULA SEGUNDA – DO PAGAMENTO</p>
            <p class="paragrafo">
                2.1. Valor líquido a ser recebido pelo cliente: <span id="doc-valor-liquido" class="variavel">[Valor Líquido]</span>, acrescido do estorno da parcela.
            </p>
            <p class="paragrafo">
                2.2. Valor total a ser repassado à empresa, referente à quitação do saldo devedor, comissão, impostos, seguro e juros: <span id="doc-valor-repassado" class="variavel">[Valor Repassado]</span>.
            </p>
            <p class="paragrafo">
                Parágrafo Único: Autorizo, desde já, que a empresa POLLO CONSIG atue como minha representante para digitação e pagamento das parcelas mencionadas, relativas à compra de dívida perante os bancos citados, com a transferência para o banco Bradesco S.A, observando que os valores podem variar de acordo com os juros e coeficientes do dia, mediante aprovação da operação.
            </p>
            <p class="clausula">CLÁUSULA TERCEIRA – DA ABERTURA DE CONTAS</p>
            <p class="paragrafo">
                3.1 . Caixa Econômica Federal : A abertura de conta será realizada para fins de averbação da margem consignável, conforme liberação das parcelas pelos bancos. Esta conta será utilizada também para TED dos valores, garantindo segurança para a empresa intermediadora e para o cliente. O cliente deverá, ainda, assinar e reconhecer firma do documento da TED, que será emitido com os valores das transferências.
            </p>
            <p class="paragrafo">
                3.2. Bradesco S.A : A abertura de conta será exigida para aprovação e pagamento do contrato. O banco solicita a abertura para que todos os aceites sejam realizados via aplicativo.
            </p>
            <p class="paragrafo">
                Parágrafo Único: Tenho ciência de que o banco pode levar de 7 (sete) a 10 (dez) dias para liberar a margem para averbação da proposta. Passado esse prazo, será feita cobrança ao banco. Autorizo o uso da minha senha do SOU GOV e do e-mail, exclusivamente para fins de consulta da margem consignável e eventuais autorizações, com a minha ciência.
            </p>

            <p class="paragrafo" style="text-indent: 0; margin-left: 0;">
                Ciente das informações acima e do disposto no parágrafo único, no qual preciso fornecer a senha do SOU GOV e email, assino abaixo:
            </p>
            <p class="assinatura" style="margin-top: 60px;">
                ASSINATURA DO DEVEDOR: _________________________________________
            </p>
            <p class="clausula">CLÁUSULA QUARTA – DAS CONDIÇÕES DA OPERAÇÃO</p>
            <p class="paragrafo">
                4.1 . Declaro estar ciente de que, uma vez assinada esta transação, será realizada a quitação dos contratos indicados, não sendo possível o cancelamento ou desistência da operation junto à nova instituição financeira até sua completa finalização.
            </p>
            <p class="clausula">CLÁUSULA QUINTA – DAS TESTEMUNHAS</p>
            <p class="paragrafo">
                5.1. Para contratos de clientes com idade superior a 60 (sessenta) anos, conforme a Lei nº 14.423, de 22 de julho de 2022, será exigida a assinatura de uma testemunha de primeiro grau com vínculo familiar com o cliente.
            </p>
            <p class="paragrafo">
                5.2. Na ausência de parente próximo ou caso o cliente opte por não contar com testemunha, será necessário o envio de um vídeo, no qual o cliente declare plena ciência do contrato e manifeste sua decisão de não ter testemunha. Esse vídeo deverá ser anexado à documentação da operação para fins de formalização.
            </p>
            <p class="paragrafo">
                Parágrafo Único: Comprometo-me a não utilizar a margem consignável correspondente ao contrato quitado em outra consignatária, devendo a mesma permanecer disponível até a conclusão da operação e contratação do novo contrato, intermediado pela Aliança Consig de Seguros Ltda., na instituição financeira que oferecer a melhor condição disponível no dia ou conforme indicação da empresa, respeitando meu perfil de crédito. Essa conduta visa manter a boa-fé na negociação, conforme a legislação vigente.
            </p>
            <p class="clausula">CLÁUSULA SEXTA – DA RESPONSABILIDADE CIVIL E PENAL</p>
            <p class="paragrafo">
                6.1. Declaro ter pleno conhecimento do conteúdo deste instrumento. Em caso de uso indevido da margem liberada junto a outra instituição financeira, estarei sujeito à responsabilização por eventual crime, que poderá ser comunicado às autoridades competentes.
            </p>
            <p class="assinatura" style="margin-top: 60px;">ASSINATURA DO CREDOR: _________________________________________</p>
            <p class="assinatura">ASSINATURA DO DEVEDOR: _______________________________________</p>
            <p class="assinatura">
                TESTEMUNHA (Grau de Parentesco): __________________________
            </p>
            <p class="assinatura" style="margin-top: 20px;">POLLO PROMOTORA LTDA</p>
            <p class="data-local" style="margin-top: 20px;">
                <span id="doc-local-data" class="variavel">[Local e Data]</span>
            </p>
        </div>
    </div>


    <script>
        window.ultimoClientePDF = {};
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // --- FUNÇÕES UTILITÁRIAS ---
        const formatarMoeda = (v) => { 
            if (typeof v === 'string') {
                if (v.startsWith('R$')) return v; 
                v = moedaParaFloat(v); 
            }
            return (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); 
        };
        const moedaParaFloat = (v) => { 
            return parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0; 
        };
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            let bgClass = 'bg-success';
            if (type === 'danger') bgClass = 'bg-danger';
            if (type === 'warning') bgClass = 'bg-warning';
            const toastEl = document.createElement('div');
            toastEl.id = toastId;
            toastEl.className = `toast ${bgClass}`;
            toastEl.textContent = message;
            toastContainer.appendChild(toastEl);
            setTimeout(() => { toastEl.classList.add('show'); }, 10);
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, 4000);
        };
        function showLoading(message) {
            document.getElementById('loading-text').textContent = message || 'Analisando PDF...';
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- INÍCIO: NOVA FUNÇÃO DE CÁLCULO ---
        function calcularAbatimento() {
            const tirouNegativo = document.getElementById('tirou-negativo').value;
            const vpuInput = document.getElementById('valor-parcelas-unificadas');
            const vnInput = document.getElementById('valor-negativo');
            const vpaInput = document.getElementById('parcela-com-abatimento'); // Parcela Com Abatimento

            if (tirouNegativo === 'Sim') {
                const valorUnificado = moedaParaFloat(vpuInput.value);
                const valorNegativo = moedaParaFloat(vnInput.value);
                
                const valorFinal = valorUnificado - valorNegativo;
                
                // Define o valor no campo do formulário (formatado)
                vpaInput.value = formatarMoeda(valorFinal);
            } else {
                // Se for "Não", limpa os campos
                vnInput.value = "";
                vpaInput.value = "";
            }
            
            // Atualiza o preview (que vai cuidar de esconder/mostrar os campos)
            atualizarPreview();
        }
        // --- FIM: NOVA FUNÇÃO DE CÁLCULO ---


        // --- FUNÇÃO ATUALIZAR PREVIEW (Simplificada) ---
        function atualizarPreview() {
            // Parte 1: Campos estáticos
            const campos = {
                'nome': ['doc-nome'], 
                'rg': ['doc-rg'],
                'cpf': ['doc-cpf'],
                'endereco': ['doc-endereco'],
                'orgao': ['doc-orgao'],
                'margem-utilizada': ['doc-margem-utilizada'],
                'valor-margem': ['doc-valor-margem'],
                'valor-parcelas-unificadas': ['doc-valor-parcelas-unificadas'],
                
                // --- ADICIONADO ---
                'tirou-negativo': ['doc-tirou-negativo'], // (Ignorado, mas necessário para o loop)
                'valor-negativo': ['doc-valor-negativo'],
                'parcela-com-abatimento': ['doc-parcela-com-abatimento'],
                // --- FIM ---

                'prazo': ['doc-prazo'],
                'valor-liquido': ['doc-valor-liquido'],
                'valor-repassado': ['doc-valor-repassado'],
                'local-data': ['doc-local-data'],
                'saldo-devedor-quitado': ['doc-saldo-devedor-quitado'],
                'valor-total-nova-instituicao': ['doc-valor-total-nova-instituicao']
            };
            const camposMoeda = [
                'valor-margem', 'valor-parcelas-unificadas', 
                
                // --- ADICIONADO ---
                'valor-negativo', 'parcela-com-abatimento',
                // --- FIM ---

                'valor-liquido', 'valor-repassado',
                'saldo-devedor-quitado', 'valor-total-nova-instituicao' 
            ];
            for (const formId in campos) {
                const inputElement = document.getElementById(formId);
                if (!inputElement) continue; 
                const valor = inputElement.value;
                const docIds = campos[formId]; 
                docIds.forEach(docId => {
                    const el = document.getElementById(docId);
                    if (!el) return; 
                    let valorFinal = valor;
                    if (camposMoeda.includes(formId) && valor.trim() !== "") {
                        const valorNumerico = moedaParaFloat(valor);
                        valorFinal = formatarMoeda(valorNumerico);
                    }
                    if (valor.trim() === "") {
                        let placeholderText = inputElement.placeholder || '';
                        if (placeholderText === 'R$ 0,00') {
                             valorFinal = 'R$ 0,00';
                        } else if (!placeholderText.startsWith('R$')) {
                             valorFinal = el.getAttribute('data-placeholder') || el.textContent; 
                             if (!el.getAttribute('data-placeholder')) {
                                el.setAttribute('data-placeholder', valorFinal); 
                             }
                        } else {
                            valorFinal = placeholderText;
                        }
                    }
                    el.textContent = valorFinal;
                });
            }
            
            // --- ADICIONADO: Lógica para esconder/mostrar campos no Preview ---
            const tirouNegativoValor = document.getElementById('tirou-negativo').value;
            const previewValorNegativo = document.getElementById('preview-valor-negativo');
            const previewParcelaAbatimento = document.getElementById('preview-parcela-abatimento');

            if (tirouNegativoValor === 'Sim') {
                previewValorNegativo.style.display = 'block';
                previewParcelaAbatimento.style.display = 'block';
            } else {
                previewValorNegativo.style.display = 'none';
                previewParcelaAbatimento.style.display = 'none';
            }
            // --- FIM DA ADIÇÃO ---


            // Parte 2: Tabela de Contratos Dinâmicos (Simplificada)
            const tbody = document.getElementById('doc-contratos-tbody');
            const itemsContrato = document.querySelectorAll('.contrato-dinamico-item');
            tbody.innerHTML = ''; 
            if (itemsContrato.length === 0) {
                tbody.innerHTML = '<tr class="placeholder-row"><td colspan="2">Nenhum contrato adicionado</td></tr>';
            } else {
                itemsContrato.forEach(item => {
                    const banco = item.querySelector('.campo-banco').value || '[Banco]';
                    let parcela = item.querySelector('.campo-parcela').value;
                    const parcelaFormatada = (parcela.trim() === "") ? '[Parcela]' : formatarMoeda(parcela);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="variavel">${banco}</span></td>
                        <td><span class="variavel">${parcelaFormatada}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function setarDataAtual() {
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const hoje = new Date();
            const dia = hoje.getDate();
            const mesNome = meses[hoje.getMonth()];
            const ano = hoje.getFullYear();
            const dataFormatada = `Brasília/DF, ${dia} de ${mesNome} de ${ano}`;
            const campoData = document.getElementById('local-data');
            if (campoData.value === "") { 
                 campoData.value = dataFormatada;
            }
        }

        // ##################################################################
        // ### FUNÇÕES DE LEITURA DE PDF (Modal, Contratos, CEP, Leitores) ###
        // ##################################################################
        
        function adicionarLinhaContrato(banco = '', parcela = '') { 
            const container = document.getElementById('contratos-dinamicos-container');
            const novoContratoDiv = document.createElement('div');
            novoContratoDiv.className = 'grid-contrato-dinamico contrato-dinamico-item';
            const parcelaFormatada = (parcela === '' || parcela === 0) ? '' : formatarMoeda(parcela);
            
            novoContratoDiv.innerHTML = `
                <div class="form-group">
                    <label>Banco:</label>
                    <input type="text" class="campo-banco" placeholder="BCO" value="${banco}">
                </div>
                <div class="form-group">
                    <label>Parcela:</label>
                    <input type="text" class="campo-parcela campo-moeda" placeholder="R$ 0,00" value="${parcelaFormatada}">
                </div>
                <button type="button" class="btn-remover-contrato" title="Remover este contrato" aria-label="Remover este contrato">&times;</button>
            `;
            container.appendChild(novoContratoDiv);
            novoContratoDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', atualizarPreview);
            });
            const novoCampoMoeda = novoContratoDiv.querySelector('.campo-moeda');
            novoCampoMoeda.addEventListener('blur', function () {
                if (this.value.trim() !== "") {
                    const valorNumerico = moedaParaFloat(this.value);
                    this.value = formatarMoeda(valorNumerico);
                    atualizarPreview(); 
                }
            });
        }
        
        function atualizarSomaModal() {
            const container = document.getElementById('contract-list');
            const sumContainer = document.getElementById('modal-sum-container');
            const sumEl = document.getElementById('modal-sum-value');
            if (!container || !sumContainer || !sumEl) return;
            const checkedBoxes = container.querySelectorAll('.loan-checkbox:checked');
            let totalSoma = 0;
            checkedBoxes.forEach(cb => {
                totalSoma += parseFloat(cb.dataset.parcela || 0);
            });
            if (totalSoma > 0) {
                sumEl.textContent = formatarMoeda(totalSoma);
                sumContainer.style.display = 'block';
            } else {
                sumEl.textContent = formatarMoeda(0);
                sumContainer.style.display = 'none';
            }
        }
        function showContractModal(loans, cliente) {
            const listaDiv = document.getElementById('contract-list');
            const infoClienteDiv = document.getElementById('infoClienteModal');
            listaDiv.innerHTML = ''; 
            if (cliente.nome || cliente.cpf) {
                document.getElementById('modal-nome-cliente').textContent = cliente.nome || 'Não lido';
                document.getElementById('modal-cpf-cliente').textContent = cliente.cpf || 'Não lido';
                infoClienteDiv.style.display = 'block';
            } else {
                infoClienteDiv.style.display = 'none';
            }
            listaDiv.innerHTML = `
                <div class="form-check select-all" style="border-bottom: 2px solid #ddd; background: #f8f9fa;">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox" style="margin-top: 0.4em;">
                    <label class="form-check-label" for="selectAllCheckbox" style="font-weight: bold; font-size: 1rem;">Selecionar Todos</label>
                </div>`;
            if (loans.length === 0) {
                listaDiv.innerHTML += '<p style="text-align: center; padding: 10px;">Nenhum contrato de EMPRÉSTIMO (filtrado) encontrado.</p>';
            }
            loans.forEach((loan, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check';
                const statusLabel = (loan.status && loan.status !== 'N/A') ? ` | Status: ${loan.status}` : '';
                const contratoLabel = (loan.contrato && loan.contrato !== 'N/A') ? `Contrato: ${loan.contrato} | ` : '';
                itemDiv.innerHTML = `
                    <input class="form-check-input loan-checkbox" type="checkbox" 
                            id="loan-${index}"
                            data-banco="${loan.banco}"
                            data-parcela="${loan.parcelaNum}"
                            data-status="${loan.status || ''}"
                            data-contrato="${loan.contrato || ''}">
                    <label class="form-check-label" for="loan-${index}">
                        <strong>${loan.banco}</strong>
                        <br><small>${contratoLabel}Parcela: ${formatarMoeda(loan.parcelaNum)}${statusLabel}</small>
                    </label>`;
                listaDiv.appendChild(itemDiv);
            });
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked);
                atualizarSomaModal();
            });
            listaDiv.addEventListener('change', (e) => {
                if (e.target.classList.contains('loan-checkbox')) {
                    const allCheckboxes = document.querySelectorAll('.loan-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAllCheckbox').checked = allChecked;
                }
                atualizarSomaModal();
            });
            document.getElementById('contract-modal-overlay').style.display = 'flex';
            atualizarSomaModal(); 
        }
        function hideContractModal() {
            document.getElementById('contract-modal-overlay').style.display = 'none';
            const listaDiv = document.getElementById('contract-list');
            if (listaDiv) {
                listaDiv.parentNode.replaceChild(listaDiv.cloneNode(true), listaDiv);
            }
        }
        
        function applySelectedContracts() {
            const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
            let contractsApplied = 0;
            let totalSomaParcelas = 0;
            checkedBoxes.forEach(cb => {
                totalSomaParcelas += parseFloat(cb.dataset.parcela || 0);
            });
            limparCamposContrato();

            const nomeClienteModal = document.getElementById('modal-nome-cliente').textContent;
            const cpfClienteModal = document.getElementById('modal-cpf-cliente').textContent;
            if (nomeClienteModal && nomeClienteModal !== 'Não lido') {
                document.getElementById('nome').value = nomeClienteModal;
            }
            if (cpfClienteModal && cpfClienteModal !== 'Não lido') {
                document.getElementById('cpf').value = cpfClienteModal;
            }
            if (window.ultimoClientePDF && window.ultimoClientePDF.orgao) {
                document.getElementById('orgao').value = window.ultimoClientePDF.orgao;
            }
            if (totalSomaParcelas > 0) {
                const campoParcelasUnificadas = document.getElementById('valor-parcelas-unificadas');
                campoParcelasUnificadas.value = formatarMoeda(totalSomaParcelas);
            }
            
            // --- ADICIONADO: Chama o cálculo de abatimento ---
            calcularAbatimento();
            // --- FIM DA ADIÇÃO ---
            
            checkedBoxes.forEach((cb, index) => {
                adicionarLinhaContrato(
                    cb.dataset.banco,
                    parseFloat(cb.dataset.parcela)
                );
                contractsApplied++;
            });

            if (contractsApplied > 0) {
                showToast(`${contractsApplied} contrato(s) e dados do cliente importados!`, 'success');
            } else if (nomeClienteModal !== 'Não lido' || cpfClienteModal !== 'Não lido') {
                showToast("Dados do cliente importados!", "success");
            } else {
                showToast("Nenhum contrato foi selecionado.", "warning");
            }
            atualizarPreview();
            hideContractModal();
        }
        function limparCamposContrato() {
            document.getElementById('contratos-dinamicos-container').innerHTML = '';
        }

        async function buscarCep() {
            const cepInput = document.getElementById('cep');
            const enderecoInput = document.getElementById('endereco');
            let cep = cepInput.value.replace(/\D/g, ''); 
            if (cep.length !== 8) return;
            enderecoInput.value = "Buscando...";
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado (erro de rede)');
                const data = await response.json();
                if (data.erro) {
                    showToast("CEP não encontrado.", "warning");
                    enderecoInput.value = "";
                    return;
                }
                let enderecoCompleto = [data.logradouro, data.bairro, `${data.localidade}/${data.uf}`]
                                        .filter(Boolean).join(', '); 
                enderecoInput.value = `${enderecoCompleto} - CEP: ${data.cep}`;
                showToast("Endereço preenchido!", "success");
                enderecoInput.focus();
            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                showToast("Erro ao buscar CEP. Verifique a conexão.", "danger");
                enderecoInput.value = "";
            } finally {
                atualizarPreview();
            }
        }
        
        // --- (Funções de processar PDF - Exercicio, SIAPE, SGP, Servidor - Vêm aqui) ---
        // (Elas são idênticas às da versão anterior, então estão compactadas para visualização)
        async function processarPdfExercicio(text) {
            let loansArray = [];
            let clienteObject = { nome: 'Não lido', cpf: 'Não lido', estado: '' };
            let clienteCpfPDF = '';
            let clienteNomePDF = '';
            let cleanText = text.replace(/--- FIM DA PÁGINA \d+ ---/g, '')
                .replace(/Consignatária\n\s*▴\s*▾[\s\S]+?Situação\n\s*▴\s*▾/g, '') 
                .replace(/Consignatária Nº Serviço Inclusão Vir.prest. Virfolha Nº Pagas Situação/g, '');
            const isOcrText = cleanText.includes('O74-SABEMI-') || cleanText.includes('R$834/12') || cleanText.includes('R$74046');
            if (isOcrText) {
                console.log("Detectado texto de OCR (Exército). Usando parser tolerante.");
                const cpfMatch = text.match(/(\d{3}\.\d{3}\.\d{3}-\d{2})/);
                const nomeMatch = text.match(/(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-ZÀ-Ú ]+)(?:\n([A-ZÀ-Ú ]+))?/);
                if (cpfMatch) { clienteCpfPDF = cpfMatch[0]; } else if (nomeMatch) { clienteCpfPDF = nomeMatch[2].trim(); }
                if (nomeMatch) { clienteNomePDF = nomeMatch[3].trim() + (nomeMatch[4] ? ' ' + nomeMatch[4].trim() : ''); }
                const blocos = cleanText.split(/Andamento/gi);
                blocos.forEach((bloco, index) => {
                    if (!bloco.toUpperCase().includes('EMPRÉSTIMO') && !bloco.toUpperCase().includes('DEDUT')) return;
                    let nomeBanco = 'Banco (Não lido)';
                    if (bloco.includes('SABEMI')) nomeBanco = 'SABEMI - PRIVADA';
                    const valorMatches = bloco.match(/R\$\s*([\d.,\/]+)/g);
                    if (!valorMatches) return;
                    let valorStr = valorMatches[valorMatches.length - 1];
                    valorStr = valorStr.replace('/', ',').replace(/[\[|]/g, '');
                    if (!valorStr.includes(',')) {
                        let digits = valorStr.replace(/R\$\s*/, '').trim();
                        if (digits.length > 2) { valorStr = "R$ " + digits.slice(0, -2) + ',' + digits.slice(-2); }
                    }
                    const valorParcelaNum = moedaParaFloat(valorStr);
                    if (valorParcelaNum === 0) return;
                    const parcelasMatch = bloco.match(/\s*([\w\.|]+)\s+([\w\d]+)\s+Em/s);
                    if (!parcelasMatch) { console.warn('Contrato pulado (OCR não leu as parcelas):', bloco); return; }
                    let total = parcelasMatch[1].replace(/[\[|TP]/g, '').trim();
                    let pagas = parcelasMatch[2].replace(/[x|xi|nm]/g, '0');
                    if (isNaN(parseInt(pagas, 10)) || (total.toUpperCase() !== 'INDET.' && isNaN(parseInt(total, 10)))) { console.warn('Contrato pulado (OCR leu lixo nas parcelas):', bloco); return; }
                    loansArray.push({ banco: nomeBanco, parcelaNum: valorParcelaNum, status: `${pagas} de ${total}`, contrato: 'N/A' });
                });
            } else {
                console.log("Detectado texto limpo (Exército). Usando parser padrão.");
                const infoRegex = /(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-ZÀ-Ú ]+)(?:\n([A-ZÀ-Ú ]+))?/;
                const infoMatch = text.match(infoRegex);
                if (infoMatch) {
                    clienteCpfPDF = infoMatch[2].trim();
                    clienteNomePDF = infoMatch[3].trim();
                    if (infoMatch[4]) { clienteNomePDF += ` ${infoMatch[4].trim()}`; }
                } else { console.warn("Regex de Nome/CPF falhou no parser limpo (Exército)."); }
                const blocos = cleanText.split(/\n(?=\d{3}\s*-\s*)/);
                blocos.forEach((bloco, index) => {
                    if (bloco.toUpperCase().includes('EMPRÉSTIMO') && /Em\s+Andamento/.test(bloco)) {
                        const bancoMatch = bloco.match(/^([\s\S]+?)\n(\d{7})\n/);
                        const valorMatch = bloco.match(/R\$\s*[\d.,]+/);
                        const parcelasMatch = /([\w\.]+)\s*\n\s*(\d+)\s+Em\s+Andamento/;
                        const parcelasResult = bloco.match(parcelasMatch);
                        if (bancoMatch && valorMatch && parcelasResult) {
                            const nomeBanco = bancoMatch[1].replace(/\n/g, ' ').trim();
                            const numContrato = bancoMatch[2].trim();
                            const valor = valorMatch[0];
                            const total = parcelasResult[1];
                            const pagas = parcelasResult[2];
                            if (total.toUpperCase() === 'INDET.') return;
                            const valorParcelaNum = moedaParaFloat(valor);
                            loansArray.push({ banco: nomeBanco, parcelaNum: valorParcelaNum, status: `${pagas} de ${total}`, contrato: numContrato });
                        }
                    }
                });
            }
            if (loansArray.length === 0) { console.warn("Nenhum contrato 'Em Andamento' foi encontrado no formato esperado."); }
            clienteObject.nome = clienteNomePDF || 'Não lido';
            clienteObject.cpf = clienteCpfPDF || 'Não lido';
            return { loans: loansArray, cliente: clienteObject };
        }
        async function processarPdfSiape(text) {
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: '' };
            let loansFound = [];
            console.log("Tentando Regex do SIAPE (Layout Novo)...");
            const infoRegexNovo = /CPF\nMatrícula\nNome\n(?:[^\n]+\n)([^\n]+)\n(?:[^\n]+\n)([^\n]+)/;
            let infoMatchNovo = text.match(infoRegexNovo);
            if (!infoMatchNovo) {
                const infoRegexAntonio = /CPF\n(?:[^\n]+\n)([^\n]+)\nMatrícula\s+(\d+)\nNome\n([A-ZÀ-Ú ]+)/;
                const infoMatchAntonio = text.match(infoRegexAntonio);
                if (infoMatchAntonio) {
                    console.log("Regex SIAPE (Layout Antonio) detectado.");
                    infoMatchNovo = [null, infoMatchAntonio[1], infoMatchAntonio[3]]; 
                }
            }
            if (infoMatchNovo && infoMatchNovo[1] && infoMatchNovo[2]) {
                const cpfPotencial = infoMatchNovo[1].trim();
                if (/\d{3}\.\d{3}\.\d{3}-\d{2}/.test(cpfPotencial) || /\d{11}/.test(cpfPotencial.replace(/[.-]/g, ''))) {
                    cliente.cpf = cpfPotencial;
                    cliente.nome = infoMatchNovo[2].trim();
                    console.log("Cliente SIAPE (Novo) encontrado:", cliente.nome);
                } else { console.warn("Regex SIAPE (Novo) encontrou dados, mas CPF parece inválido."); }
            } else { console.warn("Regex SIAPE (Novo) falhou."); }
            const rgxEmprestimosNovo = /^([^\n]+)\n(3\d{4}\s*-\s*EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/gm;
            let matches = [...text.matchAll(rgxEmprestimosNovo)];
            if (matches.length === 0) {
                const rgxAntonioTabela = /"([\d-]+[\/\d]*)"\s*,\s*"(\d+-EMPREST[^"]+)"\s*,\s*"\d+"\s*,\s*"\d+"\s*,\s*"[^"]+"\s*,\s*"(\d+\/\d+)"\s*,\s*"(R\$\s*[\d.,]+)"/g;
                let matchesAntonio = [...text.matchAll(rgxAntonioTabela)];
                console.log(`Regex SIAPE (Tabela Antonio) encontrou ${matchesAntonio.length} contratos.`);
                matchesAntonio.forEach((match) => {
                    const [_, numContrato, nomeBanco, parcelasStr, valor] = match;
                    matches.push([null, numContrato, nomeBanco, valor, parcelasStr]);
                });
            }
            matches.forEach((match) => {
                const [_, numContrato, nomeBanco, valor, parcelasStr] = match;
                let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '').replace('EMPREST BCO PRIVADOS ', '').replace('EMPREST PREV PRIVADA - ', '').trim();
                const [pagas, total] = parcelasStr.split('/');
                const valorParcelaNum = moedaParaFloat(valor);
                if (parseInt(total, 10) > 900) return; 
                loansFound.push({ banco: cleanNomeBanco, parcelaNum: valorParcelaNum, status: `${pagas.trim()} de ${total.trim()}`, contrato: numContrato.trim() });
            });
            if (loansFound.length === 0) {
                console.warn("Regex SIAPE (Novo Contratos) falhou. Tentando Regex antigo (da Calculadora)...");
                if (cliente.cpf === 'Não lido') {
                    const headerRegexAntigo = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
                    let headerMatchAntigo = text.match(headerRegexAntigo);
                    if (headerMatchAntigo) {
                        cliente.cpf = headerMatchAntigo[1].trim();
                        cliente.nome = headerMatchAntigo[2].trim();
                        console.log("Cliente SIAPE (Antigo) encontrado:", cliente.nome);
                    }
                }
                const rgxAntigo = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
                let matchesAntigo = [...text.matchAll(rgxAntigo)];
                matchesAntigo.forEach((match) => {
                    const [_, nomeBanco, valor, parcelasStr] = match;
                    let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '').trim();
                    const [pagas, total] = parcelasStr.split('/');
                    const valorParcelaNum = moedaParaFloat(valor);
                    if (parseInt(total, 10) > 900) return;
                    loansFound.push({ banco: cleanNomeBanco, parcelaNum: valorParcelaNum, status: `${pagas} de ${total}`, contrato: 'N/A' });
                });
            }
            if (cliente.cpf === 'Não lido') {
                const headerRegexAntigo = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
                let headerMatchAntigo = text.match(headerRegexAntigo);
                if (headerMatchAntigo) {
                    cliente.cpf = headerMatchAntigo[1].trim();
                    cliente.nome = headerMatchAntigo[2].trim();
                    console.log("Cliente SIAPE (Antigo-Fallback) encontrado:", cliente.nome);
                }
            }
            return { loans: loansFound, cliente: cliente };
        }
        async function processarPdfContrachequeSGP(text) {
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: '', profissao: '', orgao: '' };
            let loansArray = [];
            console.log("Processando como Contracheque PENSIONISTA (SGP/SIGEPE)...");
            const nomeMatch = text.match(/PENSAO\/AL\s+AL\s+([A-ZÀ-Ú ]+)\s+(\d{8}|\d{7})\s+([A-ZÀ-Ú ]+)\s+([^\n]+)/);
            if (nomeMatch && nomeMatch[1]) {
                cliente.nome = nomeMatch[1].trim();
                cliente.profissao = nomeMatch[4].trim();
                console.log("Regex (Nome/Função) A (Depurador) funcionou!", cliente.nome, cliente.profissao);
            } else {
                console.warn("Regex (Nome/Função) A falhou. Tentando Fallback B...");
                const nomeMatchFallback = text.match(/NOME DO BENEFICIÁRIO DE PENSÃO(?:.|\n)+?([A-ZÀ-Ú ]{3,}\s[A-ZÀ-Ú ]{3,})/);
                if(nomeMatchFallback) cliente.nome = nomeMatchFallback[1].trim();
            }
            const cpfMatch = text.match(/\n00\s*\n\s*(\d{11})\s*\n\s*\d{3}-/);
             if (cpfMatch && cpfMatch[1]) {
                cliente.cpf = cpfMatch[1].trim();
                console.log("Regex (CPF) A funcionou!", cliente.cpf);
            } else {
                console.warn("Regex (CPF) A falhou. Tentando Fallback B...");
                 const cpfMatchFallback = text.match(/CPF(?:.|\n)+?(\d{11})/);
                 if(cpfMatchFallback) cliente.cpf = cpfMatchFallback[1].trim();
            }
            const orgaoMatch = text.match(/([A-ZÀ-Ú ]+)\s+COMPROVANTE DE RENDIMENTOS DE BENEFICIÁRIO DE PENSÃO/);
            if (orgaoMatch && orgaoMatch[1]) {
                cliente.orgao = orgaoMatch[1].trim(); 
                console.log("Regex (Órgão) A funcionou!", cliente.orgao);
            } else { console.warn("Regex (Órgão) A falhou."); }
            const ufMatch = text.match(/UPAG\/([A-Z]{2})/); 
            if (ufMatch && ufMatch[1]) {
                cliente.estado = ufMatch[1].trim();
            } else { console.warn("Regex (UF) falhou no Contracheque"); }
            const descontosRegex = /(?:(\d{3})\s*\n\s*)?([\d.,]+)\s*\n\s*((?:EMPREST|AMORT)[^\n]+)/g;
            let matches = [...text.matchAll(descontosRegex)];
            if (matches.length === 0) {
                 console.log("Regex de Desconto A falhou. Tentando Fallback (B)...");
                 const descontosRegexFallback = /(?:(\d{3})\s+)?([\d.,]+)\s+((?:EMPREST|AMORT)[^\n]+)/g;
                 matches = [...text.matchAll(descontosRegexFallback)];
            }
            console.log(`Contracheque (Pensionista): Encontrados ${matches.length} descontos.`);
            matches.forEach((match) => {
                const prazo = match[1] || 'N/A';
                const valorStr = match[2];
                const nomeBanco = match[3].trim();
                const valorParcelaNum = moedaParaFloat(valorStr);
                if (valorParcelaNum > 5.00) {
                     loansArray.push({ banco: nomeBanco, parcelaNum: valorParcelaNum, status: `Prazo: ${prazo}`, contrato: 'N/A' });
                }
            });
            return { loans: loansArray, cliente: cliente };
        }
        async function processarPdfContrachequeServidor(text) {
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: '', profissao: '', orgao: '' };
            let loansArray = [];
            console.log("Processando como Contracheque SERVIDOR (SGP/SIGEPE)...");
            const nomeCargoMatch = text.match(/\n([A-ZÀ-Ú ]+)\s*\n\s*(\d{7,9})\s*\n\s*(\d{7,9})\s*\n\s*([A-ZÀ-Ú -]+)\s*\n\s*[A-Z]\s*\n\s*[A-Z]/);
            if (nomeCargoMatch) {
                cliente.nome = nomeCargoMatch[1].trim();
                cliente.profissao = nomeCargoMatch[4].trim().replace(/\s+/g, ' '); 
                console.log("Regex (Servidor Nome/Profissao) A funcionou!", cliente.nome, cliente.profissao);
            } else {
                console.warn("Regex (Servidor Nome/Profissao) A falhou. Tentando Fallbacks...");
                const nomeMatchFallback = text.match(/NOME DO SERVIDOR(?:.|\n)+?([A-ZÀ-Ú ]{3,}\s[A-ZÀ-Ú ]{3,})/);
                if(nomeMatchFallback) cliente.nome = nomeMatchFallback[1].trim();
                const cargoMatchFallback = text.match(/CARGO\/EMPREGO(?:.|\n)+?([A-ZÀ-Ú -]+)\s*\n\s*[A-Z]\s*\n\s*[A-Z]\s+/);
                if(cargoMatchFallback) cliente.profissao = cargoMatchFallback[1].trim().replace(/\s+/g, ' ');
            }
            const cpfMatch = text.match(/CPF\s*\n\s*(\d{11})/);
            if (cpfMatch && cpfMatch[1]) {
                cliente.cpf = cpfMatch[1].trim();
                console.log("Regex (Servidor CPF) A funcionou!", cliente.cpf);
            } else {
                console.warn("Regex (Servidor CPF) A falhou. Tentando Fallback B...");
                 const cpfMatchFallbackB = text.match(/\n(\d{11})\s*\n\s*(\d{3})\s*\n\s*(\d{6})\s+/); 
                 if(cpfMatchFallbackB) {
                     cliente.cpf = cpfMatchFallbackB[1].trim();
                 } else {
                    console.warn("Regex (Servidor CPF) B falhou. Tentando Fallback C...");
                    const cpfMatchFallbackC = text.match(/\n00\s*\n\s*00\s*\n\s*(\d{11})/); 
                    if(cpfMatchFallbackC) cliente.cpf = cpfMatchFallbackC[1].trim();
                 }
            }
            const orgaoMatch = text.match(/([A-ZÀ-Ú .]+)\s*\n\s*NORMAL\s*\n\s*(?:JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ) \d{4}/);
            if (orgaoMatch && orgaoMatch[1]) {
                cliente.orgao = orgaoMatch[1].trim();
                console.log("Regex (Servidor Órgão) A funcionou!", cliente.orgao);
            } else { console.warn("Regex (Servidor Órgão) A falhou."); }
            const ufMatch = text.match(/\n([A-Z]{2})\s*\n\s*EST\s*\n\s*([A-ZÀ-Ú ]+)/);
            if (ufMatch && ufMatch[1]) {
                cliente.estado = ufMatch[1].trim();
                console.log("Regex (Servidor UF) A funcionou!", cliente.estado);
            } else { console.warn("Regex (Servidor UF) A falhou."); }
            const descontosRegex = /(?:(\d{3})\s*\n\s*)?([\d.,]+)\s*\n\s*((?:EMPREST|AMORT)[^\n]+)/g;
            let matches = [...text.matchAll(descontosRegex)];
            if (matches.length === 0) {
                 console.log("Regex de Desconto A falhou. Tentando Fallback (B)...");
                 const descontosRegexFallback = /(?:(\d{3})\s+)?([\d.,]+)\s+((?:EMPREST|AMORT)[^\n]+)/g;
                 matches = [...text.matchAll(descontosRegexFallback)];
            }
            console.log(`Contracheque (Servidor): Encontrados ${matches.length} descontos.`);
            matches.forEach((match) => {
                const prazo = match[1] || 'N/A';
                const valorStr = match[2];
                const nomeBanco = match[3].trim();
                const valorParcelaNum = moedaParaFloat(valorStr);
                if (valorParcelaNum > 5.00) {
                     loansArray.push({ banco: nomeBanco.replace(/\s+/g, ' '), parcelaNum: valorParcelaNum, status: `Prazo: ${prazo}`, contrato: 'N/A' });
                }
            });
            return { loans: loansArray, cliente: cliente };
        }
        
        async function parsearPdf(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = null;
            showLoading('Analisando...');
            const loadingText = document.getElementById("loading-text");
            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = '';
                let result = { loans: [], cliente: { nome: '', cpf: '', estado: '', profissao: '', orgao: '' } };
                window.ultimoClientePDF = {}; 
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textFound = false;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) textFound = true;
                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n--- FIM DA PÁGINA ' + i + ' ---\n\n';
                    }
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNATÁRIA') || extractedText.toUpperCase().includes('EMPRÉSTIMO') || extractedText.toUpperCase().includes('CPF') || extractedText.toUpperCase().includes('RUBRICA') || extractedText.toUpperCase().includes('COMPROVANTE DE RENDIMENTOS');
                    if (extractedText.trim().length < 50 || !hasRealData) {
                        textFound = false;
                        console.log("Texto 'limpo' não parece válido. Forçando OCR (Plano B).");
                    }
                    if (!textFound) {
                        console.warn("PDF parece ser uma imagem. Iniciando OCR...");
                        extractedText = '';
                        if (typeof Tesseract === 'undefined') throw new Error("Tesseract.js não foi carregado.");
                        const worker = await Tesseract.createWorker('por');
                        for (let i = 1; i <= pdf.numPages; i++) {
                            loadingText.textContent = `Lendo imagem: Página ${i} de ${pdf.numPages}...`;
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text: ocrText } } = await worker.recognize(canvas);
                            extractedText += ocrText + '\n\n';
                        }
                        await worker.terminate();
                        console.log("OCR Concluído.");
                    }
                    
                    if (extractedText.includes("DE BENEFICIÁRIO DE PENSÃO")) {
                        console.log("Detectado: Contracheque PENSIONISTA (SGP/SIGEPE)");
                        result = await processarPdfContrachequeSGP(extractedText);
                    } else if (extractedText.includes("COMPROVANTE DE RENDIMENTOS - FOLHA")) {
                        console.log("Detectado: Contracheque SERVIDOR (SGP/SIGEPE)");
                        result = await processarPdfContrachequeServidor(extractedText);
                    } else if (extractedText.includes("Extrato de Consignações Vigentes") || extractedText.includes("Rubrica\nSequência") || extractedText.includes("Rubrica\n")) {
                        console.log("Detectado: Extrato SIAPE");
                        result = await processarPdfSiape(extractedText);
                    } else {
                        console.log("Detectado: Extrato Exército (Padrão)");
                        result = await processarPdfExercicio(extractedText);
                    }
                    
                    window.ultimoClientePDF = result.cliente; 
                    showToast("Documento lido e convênio detectado!", "success");
                    showContractModal(result.loans, result.cliente); 
                } catch (error) {
                    console.error("Erro ao processar o PDF:", error);
                    showToast(`Erro ao ler o PDF: ${error.message}`, "danger");
                } finally {
                    hideLoading();
                }
            };
            fileReader.readAsArrayBuffer(file);
        }
        
        // ##################################################################
        // ### FIM - FUNÇÕES DE LEITURA DE PDF ###
        // ##################################################################
        

        // --- INICIALIZAÇÃO E EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setarDataAtual();
            atualizarPreview(); 

            document.querySelectorAll('#form-container input, #form-container select').forEach(input => {
                input.addEventListener('input', atualizarPreview);
                if (input.classList.contains('campo-moeda')) {
                    input.addEventListener('blur', function() {
                        if (this.value.trim() !== "") {
                            const valorNumerico = moedaParaFloat(this.value);
                            this.value = formatarMoeda(valorNumerico); 
                            atualizarPreview();
                        }
                    });
                }
            });

            const uploadArea = document.getElementById('upload-label');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('hover');
                if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === "application/pdf") {
                    document.getElementById('pdf-upload').files = e.dataTransfer.files;
                    document.getElementById('pdf-upload').dispatchEvent(new Event('change'));
                } else if (e.dataTransfer.files.length > 0) {
                    showToast("Por favor, arraste apenas arquivos PDF.", "warning");
                }
            });
            document.getElementById("pdf-upload").addEventListener("change", parsearPdf);
            document.getElementById('limpar-contratos-btn').addEventListener('click', () => {
                limparCamposContrato();
                atualizarPreview(); 
                showToast("Campos de contrato limpos.", "success");
            });
            document.getElementById('modal-cancel-btn').addEventListener('click', hideContractModal);
            document.getElementById('modal-apply-btn').addEventListener('click', applySelectedContracts);
            document.getElementById('btn-add-contrato').addEventListener('click', () => {
                adicionarLinhaContrato();
                atualizarPreview();
            });
            document.getElementById('contratos-dinamicos-container').addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('btn-remover-contrato')) {
                    e.target.closest('.contrato-dinamico-item').remove();
                    atualizarPreview(); 
                }
            });
            document.getElementById('btn-logout').addEventListener('click', () => {
                if (confirm("Você tem certeza que deseja sair?")) {
                    localStorage.removeItem('isAuthenticated');
                    window.location.replace('index.html'); 
                }
            });
            document.getElementById('cep').addEventListener('blur', buscarCep);
            
            // --- INÍCIO: NOVOS LISTENERS PARA O CÁLCULO ---
            const negativoSelect = document.getElementById('tirou-negativo');
            const negativoContainer = document.getElementById('negativo-container');
            const valorNegativoInput = document.getElementById('valor-negativo');
            const valorUnificadoInput = document.getElementById('valor-parcelas-unificadas');
            
            // Listener para mostrar/esconder o container do formulário
            negativoSelect.addEventListener('change', () => {
                if (negativoSelect.value === 'Sim') {
                    negativoContainer.style.display = 'block';
                } else {
                    negativoContainer.style.display = 'none';
                }
                // Recalcula (para limpar os campos se for "Não")
                calcularAbatimento();
            });

            // Listeners para recalcular quando os valores mudarem (ao sair do campo)
            valorNegativoInput.addEventListener('blur', calcularAbatimento);
            valorUnificadoInput.addEventListener('blur', calcularAbatimento);
            // --- FIM: NOVOS LISTENERS ---
            
            // Listener do botão Gerar PDF
            document.getElementById('gerar-pdf').addEventListener('click', gerarPdf);
        });


        // --- LÓGICA DE GERAR PDF (ATUALIZADA para html2pdf.js) ---
        async function gerarPdf() {
            const botao = document.getElementById('gerar-pdf');
            botao.textContent = 'Gerando PDF...';
            botao.disabled = true;

            const nomeInput = document.getElementById('nome');
            const nomePessoa = nomeInput.value || 'documento';
            const filename = `${nomePessoa.trim().replace(/\s+/g, '_')}_confissao_de_divida.pdf`;

            const documentoCompleto = document.getElementById('documento-completo');
            atualizarPreview(); 

            const opt = {
                margin: [15, 25, 30, 25], 
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: {
                    scale: 2, 
                    useCORS: true,
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'avoid-all'] } // Deixa fluir
            };

            documentoCompleto.classList.add('generating-pdf');
            document.body.classList.add('jsPDF-native-generating');

            setTimeout(() => {
                html2pdf().from(documentoCompleto).set(opt).save()
                    .then(() => {
                        showToast("PDF gerado com sucesso!");
                    })
                    .catch((err) => {
                        console.error("Erro ao gerar PDF:", err);
                        showToast("Ocorreu um erro ao gerar o PDF.", "danger");
                    })
                    .finally(() => {
                        documentoCompleto.classList.remove('generating-pdf');
                        document.body.classList.remove('jsPDF-native-generating');
                        botao.textContent = 'Gerar PDF';
                        botao.disabled = false;
                    });
            }, 150); 
        }
    </script>
</body>
</html>